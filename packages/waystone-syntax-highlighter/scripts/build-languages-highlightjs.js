'use strict';
/*
 * Build javascript passthrough modules for highlight.js languages
 */
import path from 'path';
import { EOL } from 'os';
import fs from 'fs';
import { fileURLToPath } from 'url';

const autogenMessage = `//${EOL}// This file has been auto-generated by the 'pnpm generate:languages' task${EOL}//${EOL}${EOL}`;

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

function createSupportedLanguagesArray(files) {
  let lines = [autogenMessage, `export const SUPPORTED_LANGUAGES = [`];
  lines = lines.concat(files.map((file) => `\n  '${file.split('.js')[0]}',`));
  lines.push(EOL, '] as const;', EOL, EOL);
  lines.push(
    'export type SupportedLanguage = (typeof SUPPORTED_LANGUAGES)[number];',
    EOL,
    EOL
  );
  lines.push('export default SUPPORTED_LANGUAGES;', EOL);

  fs.writeFile(
    path.join(__dirname, `../src/lib/supportedLanguages.generated.ts`),
    lines.join(''),
    (err) => {
      if (err) {
        throw err;
      }
    }
  );
}

fs.readdir(
  path.join(__dirname, '../node_modules/highlight.js/lib/languages'),
  (err, files) => {
    if (err) {
      throw err;
    }

    files = files.filter((file) => !file.endsWith('.js.js'));
    createSupportedLanguagesArray(files);
  }
);
