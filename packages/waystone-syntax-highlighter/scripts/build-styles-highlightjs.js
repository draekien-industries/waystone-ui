'use strict';
/*
 * Quick and dirty script to build javascript stylesheets from highlight.js css
 */
import { join, dirname } from 'path';
import { EOL } from 'os';
import { readdir, writeFile, readFile } from 'fs';
import { fileURLToPath } from 'url';

import { parse } from 'css';
import camel from 'to-camel-case';

const autogenMessage = `//${EOL}// This file has been auto-generated by the 'pnpm generate:styles' task${EOL}//${EOL}${EOL}`;

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

readdir(
  join(__dirname, '../node_modules/highlight.js/styles'),
  (err, files) => {
    if (err) {
      throw err;
    }

    files.forEach((file) => {
      if (file.includes('.css')) {
        createJavascriptStyleSheet(file);
      }
    });

    const onlyCSSFiles = files.filter((file) => file.includes('.css'));
    const availableStyleNames = onlyCSSFiles
      .map((file) =>
        file.split('.css')[0] === 'default'
          ? 'default-style'
          : file.split('.css')[0]
      )
      .map(camel);
    const styles = availableStyleNames.map((name) => `${EOL}* ${camel(name)}`);
    const defaultExports = availableStyleNames.map(
      (name) => `export * from './${name}.generated';${EOL}`
    );
    const styleMD = `## Available \`stylesheet\` props ${styles.join('')}`;
    writeFile(
      join(__dirname, '../AVAILABLE_STYLES_HLJS.MD'),
      styleMD,
      (err) => {
        if (err) {
          throw err;
        }
      }
    );
    writeFile(
      join(__dirname, '../src/lib/styles/index.ts'),
      defaultExports.join(''),
      (err) => {
        if (err) {
          throw err;
        }
      }
    );

    const lines = [
      autogenMessage,
      `export const SYNTAX_HIGHLIGHT_STYLES = [${availableStyleNames
        .sort()
        .map((style) => `${EOL}  '${style}'`)}${EOL}] as const;${EOL}`,
    ];

    lines.push(
      `export type SyntaxHighlightStyle = (typeof SYNTAX_HIGHLIGHT_STYLES)[number];${EOL}`
    );
    lines.push(`export default SYNTAX_HIGHLIGHT_STYLES;${EOL}`);

    writeFile(
      join(__dirname, '../src/lib/highlightStyles.generated.ts'),
      lines.join(EOL),
      (err) => {
        if (err) {
          throw err;
        }
      }
    );
  }
);

function createJavascriptStyleSheet(file) {
  const ignoreStyleWithThis = '.hljs a';
  const fileWithoutCSS =
    file.split('.css')[0] === 'default'
      ? 'default-style'
      : file.split('.css')[0];
  readFile(
    join(__dirname, `../node_modules/highlight.js/styles/${file}`),
    'utf-8',
    (err, data) => {
      if (err) {
        throw err;
      }
      const javacriptStylesheet = parse(data).stylesheet.rules.reduce(
        (sheet, rule) => {
          if (rule.type === 'rule') {
            const style = rule.selectors.reduce((selectors, selector) => {
              if (!selector.includes(ignoreStyleWithThis)) {
                const selectorObject = rule.declarations.reduce(
                  (declarations, declaration) => {
                    if (
                      declaration.type === 'declaration' &&
                      declaration.property
                    ) {
                      declarations[camel(declaration.property)] =
                        declaration.value;
                    }
                    return declarations;
                  },
                  {}
                );
                selectors[selector.substring(1)] = selectorObject;
              }
              return selectors;
            }, {});
            sheet = Object.keys(style).reduce((stylesheet, selector) => {
              if (stylesheet[selector]) {
                stylesheet[selector] = Object.assign(
                  {},
                  stylesheet[selector],
                  style[selector]
                );
              } else {
                stylesheet[selector] = style[selector];
              }
              return stylesheet;
            }, sheet);
          }
          return sheet;
        },
        {}
      );
      writeFile(
        join(
          __dirname,
          `../src/lib/styles/${camel(fileWithoutCSS)}.generated.ts`
        ),
        `export const ${camel(fileWithoutCSS)} = ${JSON.stringify(
          javacriptStylesheet,
          null,
          2
        ).replaceAll('"', "'")}${EOL}`,
        (err) => {
          if (err) {
            throw err;
          }
        }
      );
    }
  );
}
